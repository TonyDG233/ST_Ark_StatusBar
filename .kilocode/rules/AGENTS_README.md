# Agent 统一指南 (AGENTS_README)

## 1. 项目定义
- **项目名称**: ARK_STATUSBAR (暂定)
- **核心目标**: 在 SillyTavern 中构建一个深度还原《明日方舟》体验的“游戏化”系统。不仅是 UI 美化，更包含复杂的剧情控制、变量管理和沉浸式交互。
- **运行环境**: 
    - **宿主**: SillyTavern (酒馆)
    - **加载器**: Tavern Helper (酒馆助手)
    - **核心依赖**: Prompt Template Plugin (提示词模板插件，用于处理 Worldbook 和 EJS 逻辑)

### 1.1 环境释义 (关键)
*   **Tavern Helper (酒馆助手)**:
    *   **本质**: 一个前端 JS 运行环境插件。
    *   **能力**: 提供完整的 JS 运行时和对接酒馆功能的 API (如 `@types/function/worldbook.d.ts` 中的函数)。
    *   **位置**: 本项目 (`src/ARK_STATUSBAR`) 的代码运行于此环境，因此可以直接调用这些全局 API。
*   **Prompt Template Plugin (提示词模板插件)**:
    *   **本质**: 一个主要在后端/世界书条目中运行 EJS 代码的独立插件。
    *   **用途**: 适合做提示词的选择性推送。本项目不直接在此环境中运行，但可能与其逻辑有交互。
*   **MVU**:
    *   **本质**: 基于 Tavern Helper 开发的次级插件框架。

### 1.2 关键索引 (Key Index)
**以下路径包含开发必须参考的核心定义与文档，Agent 必须在编码前查阅：**
1.  **`@types/` (最重要的 API 定义)**
    *   **重要性**: ⭐⭐⭐⭐⭐
    *   **说明**: 包含所有可调用的函数定义。**任何功能实现前，必须先阅读此文件夹下的定义文件**，了解有哪些现成的函数可以直接调用解决问题，严禁重复造轮子或臆想 API。
2.  **`references/doc_ST-Prompt-Template/` (提示词插件参考)**
    *   **重要性**: ⭐⭐⭐⭐⭐
    *   **说明**: “提示词模板插件”的参考文档。**凡是涉及提示词、世界书内运行的代码内容、EJS 渲染逻辑，必须先行参考该文档内容。**无需用户提醒，Agent 应主动查阅。

## 2. 核心原则 (用户铁律)
- **用户是唯一的领域专家**：设计和功能以用户需求为准，Agent 负责技术实现。
- **杜绝臆想**：遇到不确定的逻辑（尤其是旧代码的 DOM 挂载、Wiki 爬虫），必须先阅读源码或文档，严禁瞎编。
- **微小胜利**：分阶段交付，每个阶段必须产出“可直接在角色卡中使用的成品”。

### 2.1 协同工作协议 (Collaborative Protocol)
为了保证高效、准确的开发，Agent 必须遵守以下协同模式：
1.  **主动提问 (Ask First)**:
    *   当用户提出需求、计划或指令时，必须仔细审视。
    *   **如果有任何不理解、不清楚的地方，必须主动进行提问**，直到完全理解所需内容。不要通过猜测来填补空白。
2.  **停顿咨询 (Pause & Consult)**:
    *   在代码撰写过程中，如果发现对项目背景、环境细节或逻辑实现有疑问，**必须立即暂停编写工作**。
    *   **主动向用户提出咨询**。用户有义务回答你的所有提问，请随意询问。这一步能避免大量的返工。
3.  **可追溯日志 (Traceable Logging)**:
    *   **开启开发**: 进行每一轮开发工作前，必须在分析需求并提出大致计划后，于 `.kilocode/development_logs/` 中撰写开发日志 (如 `00X_Title.md`)。
    *   **更新状态**: 在以下节点，**必须主动**在日志文件和本 `AGENTS_README.md` (第 7 节) 中更新状态：
        *   开发进度达成里程碑。
        *   用户提出暂停。
        *   需要解决核心阻碍/制作技术尝试 Demo。
        *   开发工作完成。
    *   **目的**: 保证全流程可追踪、可回溯、可监管。

## 3. 参考项目深度解析 (`references`)
我们在开发中将严格参考以下资源：

1.  **现有前后端项目 (`参考_1.1`)**
    *   *参考价值*: **UI 风格与流程逻辑**。
    *   *具体复用*: 开场 UI 的设计风格、不同开局跳转的逻辑、EJS/提示词模板的使用模式。
2.  **少前 UI 项目 (`参考_1.2`)**
    *   *参考价值*: **设计理念与爬虫逻辑**。
    *   *具体复用*: 通讯栏（私聊）概念、Wiki 资源获取思路（需针对 PRTS Wiki 重新设计爬虫）、干员档案显示风格（需魔改为方舟风）。
3.  **旧剧情模块 (`参考_1.3`)**
    *   *参考价值*: **DOM 挂载技术**。
    *   *具体复用*: “自动挂载到最新消息底部”的核心代码、页面切换时的重挂载/防抖逻辑。这是 UI 能否稳定存在的基石。
4.  **Prompt Template 文档 (`参考_1.4`)**
    *   *参考价值*: **底层 API 字典**。
    *   *具体复用*: 编写 Worldbook 和 MVU 逻辑时的圣经。所有涉及提示词推送、EJS 渲染的操作必须查阅此文档。

## 4. 开发路线图 (Roadmap)

### 阶段一：世界线管控者 (The Worldline Manager)
**目标**: 交付一个可用的“开局与世界书管理器”。
**核心功能**:
1.  **开场 UI 移植**: 将现有的 HTML/CSS 开场界面移植到 Vue，并适配 Tavern Helper 环境。
2.  **智能挂载**: 复刻并优化“旧剧情模块”的 DOM 挂载逻辑，确保 UI 稳定显示在最新消息下方。
3.  **世界书控制**: 实现“一键开关特定世界书条目”的核心功能（基于开局选项或手动按钮）。
    *   *技术点*: 后端脚本监听前端事件 -> 调用 Prompt Template API 操作 Worldbook。
4.  **屏蔽功能**: 实现“一键屏蔽单字干员条目”功能（后端脚本过滤，技术点同4.3）。

### 阶段二：罗德岛终端 (Rhodes Island Terminal)
**目标**: 接入 MVU，让 UI “活”起来。
**核心功能**:
1.  **MVU 集成**: 引入最新版 MVU 模板，建立 Zod 变量结构。
2.  **状态同步**: 前端 UI 实时读取酒馆变量（理智、干员状态、位置），并实现动态显示。
3.  **基础交互**: 在 UI 上操作（如点击基建）能反向触发后端脚本，更新 MVU 变量。

### 阶段三：泰拉通讯录 (Terra Communicator)
**目标**: 实现沉浸式的高级交互。
**核心功能**:
1.  **私聊系统**: 独立于正文的“通讯终端” UI，模拟干员发送的短信/邮件。
2.  **PRTS 爬虫**: 编写脚本从 PRTS Wiki 动态抓取干员立绘和档案数据。
3.  **记忆/上下文优化**: 基于 MVU 实现更智能的上下文管理（参考 Prompt Template 的高级用法）。

## 5. 项目结构
```
src/
├── ARK_STATUSBAR/          # 【新】核心开发目录
│   ├── index.ts            # 入口文件 (Backend Script & Mounting Logic)
│   ├── components/         # Vue UI 组件
│   │   ├── StartupNavigator.vue # [已实现] 开场导航器 (Startup UI)
│   │   ├── ReturnButton.vue     # [已实现] 返回悬浮窗 (Return Button)
│   │   └── ...                  # [计划] 状态栏、通讯录终端
│   ├── config/             # [已实现] 配置中心
│   │   ├── assets.ts       # 静态资源路径
│   │   ├── scenarios.ts    # 开局剧情配置
│   │   └── ...
│   ├── logic/              # 业务逻辑
│   │   ├── worldbook_manager.ts # [已实现] 世界书/Prompt Template 交互逻辑
│   │   ├── mvu/            # [计划] MVU 变量控制 (Phase 2)
│   │   └── crawler/        # [计划] Wiki 爬虫 (Phase 3)
│   ├── prompts/            # [计划] 提示词与世界书源码 (存储 .md/.yaml/.ejs)
│   │   ├── worldbook/      # 世界书条目 (YAML)
│   │   └── templates/      # 提示词模板 (EJS/Markdown)
│   └── types/              # [计划] Zod 类型定义 (Phase 2)
├── 角色卡示例/              # 【保留】上游同步的模板 (只读参考)
└── ...
```

## 6. MVU 变量工作流规范
所有涉及变量的操作必须严格遵循 `.kilocode/workflows/` 中的标准：

1.  **变量结构设计 (`schema.ts`)**:
    *   **库**: 必须使用 `zod` 4.x。
    *   **原则**: 优先使用 `z.record` 而非 `z.array`；数值类型使用 `z.coerce.number()`。
    *   **注册**: 必须使用 `registerMvuSchema` 注册导出的 `Schema`。
2.  **变量更新规则 (Worldbook)**:
    *   **位置**: 世界书条目 `[mvu_update]变量更新规则`。
    *   **格式**: YAML。需合并相似规则，使用嵌套结构以节省 Token。
3.  **变量初始化 (Worldbook)**:
    *   **位置**: 世界书条目 `[initvar]变量初始化勿开`。
    *   **格式**: 纯 YAML 键值对，严禁包含注释。

## 7. 开发日志 (Development Logs)
为了方便追踪开发进度，每个阶段的详细计划和执行记录将存储在 `.kilocode/development_logs/` 目录下。

*   [2026-01-08] [Phase 1: 世界线管控者 (Manager) - 开场与返回系统](.kilocode/development_logs/001_Phase1_Manager_Plan.md) - [已实现 / 待测试]

## 8. 常用指令
- `npm run build`: 构建项目
- `npm run watch`: 监听修改并热更新